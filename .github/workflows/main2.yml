name: Update file on PR merge
on:
  pull_request:
    branches:
      - main
    types: opened

jobs:
  update_date:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Amend the last commit
        run: |
          git config --global user.email "gitbot@openrct2.org"
          git config --global user.name "OpenRCT2 git bot"
          PR_COMMIT_SHA=$(git rev-parse HEAD)
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
          git checkout pr-branch
          current_version=$(cat WebApi/version)
          new_version=$(echo "$current_version" | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "$new_version" > WebApi/version
          cat WebApi/version
          git add WebApi/version
          git commit --amend --no-edit
          git push origin pr-branch --force
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
